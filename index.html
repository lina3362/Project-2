
<html>
<head>
<meta charset="utf-8">
<title>Project 2</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="js/nouislider.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto:400,900,‌​700,500,300,200,100|Roboto+Slab" rel="stylesheet">
<link rel="stylesheet" href="css/style.css" />  
<style type="text/css">

.navbar-default{
    background-color: #f6f6f6;
    color: darkslategrey
}
.navbar-default .navbar-nav .active a{
    background-color: darkslategrey;
    color: #f6f6f6;
}

@media(max-width: 768px){
    .navbar-default{
        background-color: #f6f6f6;
        color: darkslategrey;
    }
    .navbar-default .navbar-nav .active a{
        background-color: darkslategrey;
        color: #f6f6f6;
    }
}


h1 {
    font-family: "Roboto Slab", serif;
    color: #2F4F4F;
    margin-left: 30px;
    font-size: 300%;
    font-weight: 900;
}

h2 {
    font-family: "Roboto Slab", serif;
    color: #2F4F4F;
    margin-left: 30px;
    font-size: 200%;
}

h3 {
    margin-left: 480px;
}

body {
    font-family: "Roboto", sans-serif;
    padding: 30px 60px -10px 30px;
    background-color: #f6f6f6;
    color: #374e68;
}

.overlay {
    height: 0;
    width: 100%;
    left: 0;
    top: 0;
    position: fixed;
    z-index: 1;
    background-color: #010614;
    overflow-y: scroll;
}

.graphic {
    z-index:0;
}

.animalClass {
    z-index: 2;
    color: #fbfbfb;
    font-size: 18px;
    margin-top: 4em;
    margin-bottom: 4em;
    margin-left: 35%;
}

.species {
    z-index: 2;
    color: #f6f6f6;
    font-size: 16px;
    font-weight:300;
    margin-top: 0.5em;
    margin-bottom: 0.5em;

}

.icons {
    margin: 40px 30px 20px 100px;
    padding: 3px;
    border-color: #efefef;
    border-radius: 50px;
    box-shadow: 0 0 0 rgba(200, 50, 50, 0.3);
    animation: pulse 2s infinite;
}

.circles {
    cursor: pointer;
}

#slider {
    margin-bottom: 20px;
}

.countryTooltip {
    color: #425871;
    font-weight: 300;
}

#mapLegend {
    font-size: 60%;
    font-weight: 200;
    margin-bottom: 0px;
}

p.explain {
    margin-left: 500px;
    color: #80a5cc;
}

#quote {
    border: none;
    border-radius: 20px;
    margin-left: 30px;
    margin-right: 120px;
    padding:40 80 40 80;
    color: #fbfbfb;
    background-color: #162e49;
    font-size: 20px;
}

.footer {
    margin-top: 40px;
    margin-left: 40px;
    margin-bottom: 40px;
    color: #253444;
    font-size: 14px;
}

a:link {
    color: #e18f7f;
}

a:visited {
    color: #80a5cc;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(136, 67, 67, 0.3);
  }
  70% {
      box-shadow: 0 0 2px 5px rgba(200, 50, 50, 0);
  }
  100% {
      box-shadow: 0 0 0 0 rgba(200, 50, 50, 0);
  }
}
polyline{
  opacity: .3;
  stroke: #142538;
  stroke-width: 2px;
  fill: none;
}

.labelValue
{
  font-size: 60%;
  opacity: 0.5;
  color: #142538;
}

.toolTip {
    position: absolute;
    display: none;
    width: 300px;
    height: auto;
    background: none repeat scroll 0 0 white;
    opacity: 0.9;
    border:  none;
    border-radius: 5px;
    color: #425871;
    padding: 8px;
    font-weight: 300;
}
.legend text {
    font-size: 12px;
    fill: #1c2631;
}
.labelName text {
    font-size: 14px;
    fill: #425871;
}

.donutChart {
    margin-left: 40px;
    margin-bottom: 40px;
}
</style>
</head>
<body>
<div class="wrapper">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
        <div class="navbar-header">
            <img class="nav-ufo" src="icons/animals3.jpg">
            </a>
        </div>
        </div>
    </nav>
<!--Nav Bar-->
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!--Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
                aria-expanded="false">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        <!--Collect the nav links, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <!--left nac link-->
            <ul class="nav navbar-nav">
                <li>
                    <a href="index.html">Dashboard
                    </a>
                </li>
            </ul>
            <!--Right nav link -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="data.html">Data</a>
                </li>

            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>

<div class="hero text-center">
<h1>Animal Matters</h1>
<blockquote id="quote">
<p>Nature doesn't need people - people need nature; nature would survive the extinction of the human being and go on just fine, but human culture, human beings, cannot survive without nature.</p>
<p>---- Harrison Ford <i>https://www.brainyquote.com/quotes/harrison_ford_733027</i></p></blockquote>
</div>

<div class="col-md-5">
<div id="donut" class="graphic">
<br>
<br>
<h2>The IUCN Red List</h2>
<h3>All Animal Species and "At Risk" Species</h3>
<script src="js/Charts.js"></script>
</div>
        
        
<br>
<h2>Extinction by Time and Place</h2>
</br>


<div id="myNav" class="overlay"></div>
<div id="map" class="graphic"></div>
<div id="mapLegend">
<p class="explain">** pre 1960 population density shown by continents, post 1960 shown by countries **</p>
</div>
<div id="slider" class="graphic"></div>
<div class="buttons">
    <input class="icons" id="mammalExtinction" type="image" src="icons/mammal.png" 
    alt="Mammal" width="50" height="50" value="Mammal"/>
        
    <input class="icons" id="birdButton" type="image" src="icons/bird.png" 
    alt="Bird" width="50" height="50" value="Bird"/>
        
    <input class="icons" id="amphibianButton" type="image" src="icons/amphibian.png" 
    alt="Amphibian" width="50" height="50" value="Amphibian"/>
        
     <input class="icons" id="fishButton" type="image" src="icons/fish.png" 
     alt="Fish" width="50" height="50" value="Fish"/>
        
    <input class="icons" id="insectButton" type="image" src="icons/insect.png" 
    alt="Insect" width="50" height="50" value="Insect"/>
        
    <input class="icons" id="crustaceanButton" type="image" src="icons/crustacean.png" 
    alt="Crustacean" width="50" height="50" value="Crustacean"/>
</div>
        
<div class="footer">
<p>Data from <a href="https://en.wikipedia.org/wiki/Lists_of_extinct_animals">Wikipedia: Lists of extinct animals</a>, 
<a href="https://data.worldbank.org/indicator/SP.POP.TOTL">The World Bank: Total Population</a>,
and <a href="http://apiv3.iucnredlist.org">IUCN Red List API</a>.
<br>University of Denver Data Boot Camp 2020</p>
</div>
        
<script type="text/javascript">
        
var width = 1600,
    height = 550,
    padding = 20;

var projection = d3.geoRobinson().scale(200).translate([width / 2 - 150, height / 2 + 20]);

var path = d3.geoPath().projection(projection);

var circleScale = d3.scaleLinear().domain([1,52]).range([5,50]);
var mapColor = ["#f0f4f8", "#80a5cc", "#6d86a1", "#425871", "#142538"];

var svg = d3.select("#map").append("svg")
.attr("width", width)
.attr("height", height);

var layer1 = svg.append("g");
var layer2 = svg.append("g");
        
d3.queue()
.defer(d3.json, "data/continent-110m.json")
.defer(d3.csv, "data/worldPopulation.csv")
.defer(d3.csv, "data/populationBefore1960.csv")
.defer(d3.csv, "data/extinction-by-time.csv")
.defer(d3.csv, "data/coordinates.csv")


.await(function (error, world, population, popuByContinent, extinctionData, coordinates) {

    popuByContinent.forEach(function(d) {
        for (var year = 1500; year <= 1900; year += 100) {
        d[year] = Number(d[year]);
        };
        d[1950] = Number(d[1950]);
    });

    population.forEach(function(d) {
            for (var year = 1960; year <= 2010; year += 10) {
                d[year] = Number(d[year]);
            }
            d.id = Number(d.id);
    });

    var slider = document.getElementById("slider");

    var range_all_sliders = {
        'min': [ 1500, 100 ],
        '60%': [ 1900, 50],
        '70%': [ 1950, 10 ],
        'max': [ 2019 ]       
    };

    noUiSlider.create(slider, {
        connect: true,
        behaviour: "drag",
        range: range_all_sliders,
        start: [ 1800, 1950 ],
        pips: {
            mode: 'values',
            values: [1500, 1600, 1700, 1800, 1900, 1950, 1960,
                    1970, 1980, 1990, 2000, 2010,2011,2012,2013,2014,2015,2016,2017,2018,2019],
            density: 100,
            stepped: true
        }
    });

    slider.noUiSlider.on("update", function (values) {
        var from = Number(values[0]);
        var to = Number(values[1]);

        drawContinent(world, popuByContinent, population, to);
        mapExtinction(extinctionData, from, to, coordinates, "#cc0000");
    });

    var animalClassColors = ["#ffcc00","#ff8c1a","#C26C55","#C23C5F","#f53dc7","#751aff"];

    var allButtons = d3.selectAll(".icons");

    allButtons.on("click", function(d, i) {
        var animalValue = String(this.value);
        var dataByClass = extinctionData.filter(function(d) { return d["Animal Class"] == animalValue; });
        var yearRange = slider.noUiSlider.get();
        mapExtinction(dataByClass, yearRange[0], yearRange[1], coordinates, animalClassColors[i])
    })
    .on("mouseover", function() {
        d3.select(this).style("background-color", "#efecec");
    })
    .on("mouseout", function() {
        d3.select(this).style("background-color", "transparent");
    });

    createLegend();

});

    
function mapExtinction(data, from, to, coordinates, color) {

    var data = extinctionByInterval(data, from, to);
    var occurrence = countOccurrence(data);
    nestedData = d3.nest().key(function(d) { return d.country; })
        .entries(data);

    nestedData.forEach(function(d) {
        coordinates.forEach(function(e) {
            if (e.name == d.key) {
                d.coordinates = [Number(e.longitude), Number(e.latitude)];    
            }
        });
        var country = d.key
        d.count = occurrence[country];
    })

    var circles = layer2.selectAll("circle").data(nestedData);

    circles.enter().append("circle")
        .merge(circles)
        .attr("class", "circles")
        .attr("cx", function(d) { return projection(d.coordinates)[0]; })
        .attr("cy", function(d) { return projection(d.coordinates)[1]; })
        .style("fill", color)
        .transition()
        .attr("r", function(d) { return circleScale(d.count); })
        .style("opacity", 0.8);

    circles.exit().remove();
    var countryHover = d3.select("body")
        .append("div")
        .attr("class", "countryTooltip")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden");
        d3.selectAll(".circles")
        .on("mouseover", function(d) { 
        d3.select(this).attr("r", function(d) { return circleScale(d.count) + 5; }).style("opacity", 1);
        return countryHover
        .style("visibility", "visible")
        .style("background", "white")
        .style("padding", "3px")
        .style("opacity", 0.9)
        .style("border", "none")
        .style("border-radius", "5px")
        .text(d.key); 
            })
    .on("mousemove", function() { 
        d3.select(this).attr("r", function(d) { return circleScale(d.count) + 5; }).style("opacity", 1);
        return countryHover.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px"); })
    .on("mouseout", function() { 
        d3.select(this).attr("r", function(d) { return circleScale(d.count); }).style("opacity", 0.8)
        return countryHover.style("visibility", "hidden") })
        .on("click", function(d) {

        var arrayOfValues = d.values;

        var classList = [];

        arrayOfValues.forEach (function (d) {
            if (classList.indexOf(d.animalClass) == -1){
                classList.push(d.animalClass);
            };
        });

        classList.sort();

        d3.select(".overlay")
        .style("height", "100%")
        .style("opacity", 0.1)
        .transition()
        .style("opacity", 0.95);

        classList.forEach(function(d) {
            d3.select("#myNav").append("div")
            .attr("class", "animalClass")
            .attr("id", d)
            .text(d)
        });

        arrayOfValues.forEach(function(d) {
            d3.select("#"+d.animalClass).append("div")
            .attr("class", "species")
            .text(d.name + "  ,   " + d.extinctionTime);
        });
        });

        var screen = d3.select("#myNav");

        screen.on("click", function(d) {
        screen.style("height", "0%");
        d3.selectAll(".animalClass").remove();
        d3.selectAll(".species").remove();
    });
    }

function countOccurrence(array) {
    var countryList = [];

    array.forEach(function(d) {
        countryList.push(d.country);
    });
    countryList.sort();

    var occurrence = {};

    for (var i = 0, j = countryList.length; i < j; i ++) {
        occurrence[countryList[i]] = (occurrence[countryList[i]] || 0) + 1;
    }    
    return occurrence;
}
function extinctionByInterval(data, time1, time2) {
    var extinctionByInterval = [];
    data.forEach(function(d) {
        var value = new Object();
        if (d.Year >= time1 && d.Year < time2) {
            value.animalClass = d["Animal Class"];
            value.name = d["Common Name"]; 
            if (d["Common Name"] == "") {
                value.name = d["Species Name"];
                }
            value.extinctionTime = Number(d.Year);
            value.country = d.Countries.trim();
            extinctionByInterval.push(value);
        };
    });
    return extinctionByInterval; 
}


function drawContinent(data, popuContinent, popuCountry, time) {

    var countries = topojson.feature(data, data.objects.countries).features;
    var maxPopu = d3.max(popuCountry, function (d) {return d[2010];});

    var colorScale = d3.scaleLinear().domain([0, 80, 200, 500, maxPopu]).range(mapColor);

    if (time < 1960) {
        //creating data to draw continents
        var continentNames = ["Asia", "Africa", "Europe", "North America", "South America", "Oceania"];
        var continents = [];
        continentNames.forEach(function(d, i) {
        var continentName = d;
        var value = {type: "FeatureCollection", name: d, id: i + 1, 
                    color: colorScale(popuContinent[i][time]),
                    features: countries.filter(function(d) { return d.properties.continent == continentName; })
        };
        continents.push(value);
    });

        var map = layer1.selectAll("path").data(continents);

        map.enter().append("path")
            .merge(map)
            .attr("d", path)
            .style("fill", function(d) { return d.color; });
        map.exit().remove();
    } 


    else {
        popuIdAndTime = [];

        popuCountry.forEach(function(d) {
            var id = d.id;
            var population = d[time];
            popuIdAndTime.push({id:id, population:population});
        })

        countries.forEach(function(d) {
            popuIdAndTime.forEach(function(e) {
                if (e.id == d.id) {
                    d.color = colorScale(e.population);
                }
            })
        });

        var map = layer1.selectAll("path").data(countries);

        map.enter().append("path")
            .merge(map)
            .attr("d", path)
            .style("stroke", "#425871")
            .style("stroke-width", 0.5)
            .style("stroke-opacity", 0.1)
            .style("fill", function(d) { return d.color; });
        map.exit().remove();      
    }
}

function createLegend() {
    var mapLegend = d3.select("#mapLegend").append("svg").attr("width", width).attr("height", 70);

    var legendWidth = 150,
        legendHeight = 10
        translate = 900;
        var defs = mapLegend.append("defs");

    var linearGradient = defs.append("linearGradient")
    .attr("id", "linear-gradient")
    .attr("x1", "0%").attr("y1", "0%")
    .attr("x2", "100%").attr("y2", "0%");

    linearGradient.append("stop").attr("offset", "0%").attr("stop-color", mapColor[0]);
    linearGradient.append("stop").attr("offset", "60%").attr("stop-color", mapColor[1]);
    linearGradient.append("stop").attr("offset", "100%").attr("stop-color", "#68809b");

    mapLegend.append("rect")
    .attr("width", legendWidth)
    .attr("height", legendHeight)
    .attr("x", 100 + translate)
    .attr("y", 20)
    .style("fill", "url(#linear-gradient)")
    .style("stroke", mapColor[1]).style("stroke-width", 0.5).style("stroke-opacity", 0.7);

    mapLegend.append("text").attr("x", 90 + translate).attr("y", 15)
    .text("less").style("fill", mapColor[1]);

    mapLegend.append("text").attr("x", 240 + translate).attr("y", 15)
    .text("more").style("fill", mapColor[3]);

    mapLegend.append("text").attr("x", 135 + translate).attr("y", 44)
    .text("population density").style("fill", mapColor[2]);
}

</script>
</body>
